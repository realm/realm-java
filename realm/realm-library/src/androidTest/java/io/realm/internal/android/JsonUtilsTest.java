/*
 * Copyright 2015 FasterXML
 * Copyright 2015 Realm Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package io.realm.internal.android;

import androidx.test.ext.junit.runners.AndroidJUnit4;

import org.junit.Test;
import org.junit.runner.RunWith;

import java.text.ParseException;
import java.util.Calendar;
import java.util.Date;
import java.util.GregorianCalendar;
import java.util.TimeZone;

import io.realm.exceptions.RealmException;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertNotNull;
import static org.junit.Assert.assertNull;
import static org.junit.Assert.assertTrue;
import static org.junit.Assert.fail;

@RunWith(AndroidJUnit4.class)
public class JsonUtilsTest {

    @Test
    public void parseNullAndEmptyDateIsNull() {
        Date output = JsonUtils.stringToDate(null);
        assertNull("Null input should output a null date object", output);

        output = JsonUtils.stringToDate("");
        assertNull("Empty string input should output a null date object", output);
    }

    @Test
    public void parseMillisToDate() {
        Date originalDate = Calendar.getInstance().getTime();
        long dateTimeInMillis = originalDate.getTime();
        Date output = JsonUtils.stringToDate(String.valueOf(dateTimeInMillis));

        assertTrue("Dates should match", output.equals(originalDate));
    }

    @Test
    public void parseJsonDateToDate() {
        String jsonDate = "/Date(1198908717056)/"; // 2007-12-27T23:11:57.056
        Date output = JsonUtils.stringToDate(jsonDate);

        assertEquals(1198908717056L, output.getTime());
    }

    @Test
    public void negativeLongDate() {
        long timeInMillis = -631152000L; // Jan 1, 1950
        Date output = JsonUtils.stringToDate(String.valueOf(timeInMillis));

        assertEquals("Should be Jan 1, 1950 in millis", timeInMillis, output.getTime());
    }

    @Test
    public void parseInvalidDateShouldThrowRealmException() {
        String invalidLongDate = "123abc";
        try {
            Date d = JsonUtils.stringToDate(invalidLongDate);
            fail("Should fail with a RealmException.");
        } catch (RealmException e) {
            assertNotNull(e);
            assertTrue(e.getCause() instanceof ParseException);
        }
    }

    @Test
    public void parseInvalidNumericDateShouldThrowRealmException() {
        String invalidLongDate = "2342347289374398342759873495743"; // not a date.
        try {
            Date d = JsonUtils.stringToDate(invalidLongDate);
            fail("Should fail with a RealmException.");
        } catch (RealmException e) {
            assertNotNull(e);
            assertTrue(e.getCause() instanceof NumberFormatException);
        }
    }

    @Test
    public void parseISO8601Dates() throws ParseException {
        Calendar cal = new GregorianCalendar(2007, 8 - 1, 13, 19, 51, 23);
        cal.setTimeZone(TimeZone.getTimeZone("GMT"));
        cal.set(Calendar.MILLISECOND, 789);
        Date date = cal.getTime();
        cal.set(Calendar.MILLISECOND, 0);
        Date dateZeroMillis = cal.getTime();
        cal.set(Calendar.SECOND, 0);

        // Parses date with short time and decimal second.
        Date d = JsonUtils.stringToDate("2007-08-13T195123.789Z");
        assertEquals(date, d);

        // Short time without decimal second.
        d = JsonUtils.stringToDate("2007-08-13T195123Z");
        assertEquals(dateZeroMillis, d);

        // GMT+2 with decimal second.
        d = JsonUtils.stringToDate("2007-08-13T215123.789+02:00");
        assertEquals(date, d);

        // Tests without time.
        cal = new GregorianCalendar(2007, 8 - 1, 13, 0, 0, 0);
        cal.set(Calendar.MILLISECOND, 0);
        cal.setTimeZone(TimeZone.getTimeZone("GMT"));
        Date dateWithoutTime = cal.getTime();

        // Date only with hyphens.
        d = JsonUtils.stringToDate("2007-08-13Z");
        assertEquals(dateWithoutTime, d);

        // Date, no hyphens.
        d = JsonUtils.stringToDate("20070813Z");
        assertEquals(dateWithoutTime, d);

        // Hyphenated Date with empty time.
        d = JsonUtils.stringToDate("2007-08-13+00:00");
        assertEquals(dateWithoutTime, d);

        // Non-hyphenated date with empty time.
        d = JsonUtils.stringToDate("20070813+00:00");
        assertEquals(dateWithoutTime, d);

        // Please see the ISO8601UtilsTest.java file for a full suite of ISO8601 tests.
    }
}
